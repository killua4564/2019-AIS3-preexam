### RSA202
- 題目給了一個加密過後的文件(後來因為n被丟factordb 所以改成nc形式)
```
from Crypto.PublicKey import RSA
from Crypto.Util.number import getPrime, isPrime, inverse 
from secret import p, r, FLAG1, FLAG2

assert ((p-1) % r)**2 + ((r**5 - 1) % p)**2 == 0
assert isPrime(p) + isPrime(r) == 2

def next_prime(num):
    while True :
        num +=1
        if isPrime(num):
            return num

e = 65537

n1 = r * next_prime(r)
n2 = p * getPrime(1024)

enc1 = pow(FLAG1, e, n1)
enc2 = pow(FLAG2, e, n2)

print('(enc1,n1) =', (enc1,n1) )
print('(enc2,n2) =', (enc2,n2) )
```
- n1有個明顯漏洞 直接fermat func下去
```
def fermat(n):
	a = gmpy2.isqrt(n) + 1
	b = a ** 2 - n
	while not gmpy2.iroot(b, 2)[1]:
		a += 1
		b = a ** 2 - n
	b = gmpy2.iroot(b, 2)[0]
	return (a + b, a - b)
```
- 直接得到r、enc1解開
- 再來看看assert的部分
```
p, r is Prime
(p-1) % r = 0 ... (1)
(r**5-1) % p = 0 ... (2)
==> r**5 - 1 = k * p ... (2)'
==> (k*p-k) % r = 0 ... (1) * k
==> (r**5 - (k+1)) % r = 0 ... (2)' into (1) * k
==> k + 1 = r (Assume k < r)
```
- 有r得到k、有k推出p、有p推出q、enc2解開
- payload:
```
import gmpy2
from sympy import invert
from Crypto.Util.number import isPrime, long_to_bytes

e = 639129419
n1 = 3622622975725667181857157575015334279486795864201031798537168634697201541146120906389468357397534892860108513944743579325231878802587775848785579669855879882593428950450818653416433
n2 = 224321859257937029544685776624023700851472129165953883771891142140902210300636193352649868313889439859859956734743480049257650711266695049474783847910189655528077470876353823451293002702737362078971435087001631579629042409482086621888295865562646880476988815562006861432394964943950542006541656284617947909478013492774353122628781534528805973622187225401953329677928857674042430887206230330975102618507252136953001255572917792075029390804278577107008769165241643143867243252259115786614119403693803718493091191421894628576677752645208119188047189927773942703197799206747438685232494763926893528950093831081247040452974906386523473762515513452080302419359517395355218097803323189099268651511230358087169274798160299140302949
enc1 = 2946961467327474367609872314787067845961775434346914905162402201034840122783069288769358776931886089200208504761005728007124947775096027532900055224734476625882142942838603683808738
enc2 = 209771434939687015405471318554107966609590520028822535137114863978757789543198993886268711297120184341948448019800481459098522055844022028860689052004856875314393816843197545565494839907681921264873014686247053944185570638182442078064303121639343766740145352549813703352459372075356646472281661710694352905189921749382206162994873627898577811924346985700796958716276503449496769611108682232191708986381684825585297352468606861686261514836490422831430046035228796743293478188944895883561757377571042175282460051472272757098090542617528118636255903292496396966084308297984850886933614102116202437740056758011818061693857097641318924601428462706998207704477212516457676307683298927378887868673300441073252116256968747466922803

r1, r2 = fermat(n1)
phi1 = (r1-1) * (r2-1)
d1 = int(invert(e, phi1))
m1 = pow(enc1, d1, n1)
flag1 = long_to_bytes(m1)

k = r2 - 1
p = (r2 ** 5 - 1) // k
q = n2 // p
phi2 = (p-1) * (q-1)
d2 = int(invert(e, phi2))
m2 = pow(enc2, d2, n2)
flag2 = long_to_bytes(m2)

print(flag1 + flag2)
```
- flag: `AIS3{S0me7im3s_I_h4tE_factorDB}`